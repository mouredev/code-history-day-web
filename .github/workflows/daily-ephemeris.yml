name: Generar EfemÃ©ride Diaria

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 9:00 UTC (10:00 CET / 11:00 CEST)
    - cron: "0 9 * * *"

  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      date:
        description: "Fecha especÃ­fica (YYYY-MM-DD) - opcional"
        required: false
        type: string
      force:
        description: "Forzar generaciÃ³n aunque ya exista"
        required: false
        type: boolean
        default: false

jobs:
  generate-ephemeris:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Instalar dependencias
        run: npm ci

      - name: Verificar script existe
        run: |
          if [ ! -f "scripts/generate-daily-ephemeris.js" ]; then
            echo "âŒ Script no encontrado"
            exit 1
          fi
          echo "âœ… Script encontrado"

      - name: Generar efemÃ©ride
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'https://amtjsuwxolyyhxhddvbe.supabase.co' }}
        run: |
          echo "ðŸš€ Iniciando generaciÃ³n de efemÃ©ride..."

          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "ðŸ“… Generando efemÃ©ride para fecha especÃ­fica: ${{ github.event.inputs.date }}"
            node scripts/generate-daily-ephemeris.js "${{ github.event.inputs.date }}"
          else
            echo "ðŸ“… Generando efemÃ©ride para maÃ±ana"
            node scripts/generate-daily-ephemeris.js
          fi

      - name: Verificar resultado
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "âœ… EfemÃ©ride generada exitosamente"
            echo "EPHEMERIS_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ Error generando efemÃ©ride"
            echo "EPHEMERIS_STATUS=failed" >> $GITHUB_ENV
          fi

  # Job adicional para verificar la salud del sistema
  health-check:
    runs-on: ubuntu-latest
    needs: generate-ephemeris
    if: always()

    steps:
      - name: Verificar estado de Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ” Verificando conectividad con Supabase..."

          if [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "âš ï¸  SUPABASE_ANON_KEY no configurada, saltando verificaciÃ³n"
            exit 0
          fi

          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            "$SUPABASE_URL/rest/v1/ephemerides?select=count" || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… Supabase estÃ¡ funcionando correctamente"
          else
            echo "âŒ Problema con Supabase (HTTP $response)"
            exit 1
          fi

      - name: Verificar OpenAI (si estÃ¡ configurado)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ðŸ” Verificando conectividad con OpenAI..."

          if [ -z "$OPENAI_API_KEY" ]; then
            echo "âš ï¸  OPENAI_API_KEY no configurada, saltando verificaciÃ³n"
            exit 0
          fi

          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            "https://api.openai.com/v1/models" || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… OpenAI estÃ¡ funcionando correctamente"
          else
            echo "âŒ Problema con OpenAI (HTTP $response)"
            # No fallar el job por esto, solo advertir
            echo "âš ï¸  ContinÃºando de todas formas..."
          fi

  # Job para crear un issue si falla repetidamente
  create-issue-on-failure:
    runs-on: ubuntu-latest
    needs: [generate-ephemeris, health-check]
    if: failure() && github.event_name == 'schedule'

    steps:
      - name: Crear issue por fallo
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Fallo en generaciÃ³n automÃ¡tica de efemÃ©ride - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Problema detectado

            El workflow de generaciÃ³n automÃ¡tica de efemÃ©rides ha fallado en la ejecuciÃ³n programada.

            **Fecha:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}

            ## Posibles causas

            - ðŸ”‘ Problema con las API keys (OpenAI o Supabase)
            - ðŸŒ Problemas de conectividad
            - ðŸ“Š Problemas con la base de datos
            - ðŸ¤– LÃ­mites de rate de OpenAI

            ## Acciones recomendadas

            1. Verificar que las secrets estÃ©n configuradas correctamente
            2. Revisar los logs del workflow: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            3. Ejecutar manualmente el workflow para debugging
            4. Verificar el estado de los servicios externos

            ---

            Este issue fue creado automÃ¡ticamente por el workflow de GitHub Actions.
            `;

            // Buscar si ya existe un issue abierto similar
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated,ephemeris-failure'
            });

            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automated', 'ephemeris-failure', 'bug']
              });
              console.log('âœ… Issue creado por fallo en el workflow');
            } else {
              console.log('â„¹ï¸  Ya existe un issue abierto para fallos del workflow');
            }

  # Job de resumen
  summary:
    runs-on: ubuntu-latest
    needs: [generate-ephemeris, health-check]
    if: always()

    steps:
      - name: Resumen de ejecuciÃ³n
        run: |
          echo "## ðŸ“Š Resumen de EjecuciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.generate-ephemeris.result }}" = "success" ]; then
            echo "**GeneraciÃ³n:** âœ… Exitosa" >> $GITHUB_STEP_SUMMARY
          else
            echo "**GeneraciÃ³n:** âŒ FallÃ³" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "**Health Check:** âœ… Exitoso" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Health Check:** âŒ FallÃ³" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Enlaces Ãºtiles" >> $GITHUB_STEP_SUMMARY
          echo "- [Ver aplicaciÃ³n](https://tu-dominio.vercel.app)" >> $GITHUB_STEP_SUMMARY
          echo "- [Dashboard Supabase](https://supabase.com/dashboard)" >> $GITHUB_STEP_SUMMARY
          echo "- [Logs del workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
